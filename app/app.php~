<?php

use Http\Request;
require __DIR__ . '/../autoload.php';

// Config
$debug = true;

$app = new \App(new \View\TemplateEngine(
    __DIR__ . '/templates/'
), $debug);

/**
 * Index
 */
$app->get('/', function () use ($app)
	{
		return $app->render('index.php');
	});

// Récupère la liste des locations
$app->get('/locations', function(\Http\Request $request) use ($app)
	{
		$model = new Model\Locations();
		$loc = $model->findAll();
		
		return $app->render('locations.php', array("locations" => $loc));
	});
	
//Récupère une location
$app->get('/locations/(\d+)', function(\Http\Request $request, $id) use ($app)
	{
		$model = new Model\Locations();
		$loc = $model->findOneById($id);

		return $app->render('location.php', array("id" => $id, "location" => $loc));
	});
	
//Ajoute une location
$app->post('/locations/)', function(\Http\Request $request) use ($app)
	{
		$model = new Model\Locations();
		$model->create($_POST['locationName']); //on ajoute la location
		
		$app->redirect('/locations'); //nouvelle méthode de redirection
		
		//$loc = $model->findAll();
		//return $app->render('locations.php', array("locations" => $loc)); //on affiche la nouvelle liste (redirection à l'ancienne)
	});
	
//Supprime une location
$app->delete('/locations/(\d+)', function(\Http\Request $request, $id) use ($app)
	{
		$model = new Model\Locations();
		$loc = $model->findOneById($id); //on regarde si la location existe
		
		if(NULL === $loc)
			throw new \Exception\HttpException(404, "Location not foud"); //si elle existe pas on emet une exception

		$model->delete($id); //on l'a supprime
		
		$app->redirect('/locations'); //nouvelle méthode de redirection
		
		//$loc = $model->findAll();
		//return $app->render('locations.php', array("locations" => $loc)); //on affiche la nouvelle liste (redirection à l'ancienne)
	});
	
//Met à jour une location
$app->put('/locations/(\d+)', function($id) use ($app)
	{
		$model = new Model\Locations();
		$loc = $model->findOneById($id); //on regarde si la location existe
		
		if(NULL === $loc)
			throw new \Exception\HttpException(404, "Location not foud"); //si elle existe pas on emet une exception

		$model->update($_POST['locationId'], $_POST['newLocationName']); //met à jour la location
		$loc = $model->findOneById($id); //on récupère la location MAJ

		return $app->render('location.php', array("id" => $id, "location" => $loc));
	});

return $app;
